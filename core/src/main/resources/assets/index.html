<!DOCTYPE html>
<html>
<script src="ship.js"></script>
<script src="sectionController.js"></script>
<script src="clientCoordinate.js"></script>
<script src="drawer.js"></script>
<script src="event.js"></script>
<script src="model.js"></script>
<script src="modelCoordinate.js"></script>
<script src="network.js"></script>
<script src="playerProperties.js"></script>

<body style="padding:0;margin:0;overflow:hidden;">

    <canvas id="canvas" style="background-size: 100% 100%;" /> Your browser does not support the canvas element.</canvas>

    <script>
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');

        var sectionController = new SectionController();

        var userName = 'Bela';
        var initialPosition = new ClientCoordinate(-10, -10);
        var initialWidth = canvas.width = window.innerWidth;
        var initialHeight = canvas.height = window.innerHeight;

        var playerProperties = new PlayerProperties(initialPosition, initialWidth, initialHeight);
        playerProperties.setUserName(userName);

        var playerPropertiesModel = new PlayerProperties(initialPosition, initialWidth, initialHeight);

        var mouseDownCoordinate = new ClientCoordinate(0, 0);
        var mouseDownCoordinateWithCornerOffset = new ClientCoordinate(0, 0);

        var drag = false;
        var scale = 1;
        var gridSize = 42;

        var network = new Network();
        var drawer = new Drawer();
        var model = new Model();

        window.addEventListener('resize', resizeCanvas, false);

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            network.changePlayerPreferences();
            drawer.drawScene();
        }
        resizeCanvas();

        var currentTime = 0;
        var interpolationTimeSlice = 100;
        var bindedDrawer = drawer.drawScene.bind(drawer);

        var gameLoop = setInterval(function() {
            requestAnimationFrame(bindedDrawer);

            currentTime += interpolationTimeSlice;
        }, interpolationTimeSlice);

        canvas.oncontextmenu = function(event) {
            event.preventDefault();

            var x = event.pageX,
                y = event.pageY;

            var clientCornerCoordinate = playerProperties.getScreenCorner();

            var shipTargetClientCoordinate = new ClientCoordinate(clientCornerCoordinate.getX() + x, clientCornerCoordinate.getY() + y);
            var shipTargetCoordinate = shipTargetClientCoordinate.asModelCoordinate();

            var ships = model.getShips();

            for (var i = 0; i < ships.length; i++) {
                var ship = ships[i];
                if (ship.isSelected()) {
                    network.move(ship, shipTargetCoordinate);
                }
            }

        };

        canvas.addEventListener('mouseleave', function(event) {
            var x = event.pageX,
                y = event.pageY;
            drag = false;
            sectionController.resetSections();
        }, false);
        canvas.addEventListener('mousedown', function(event) {
            if (event.buttons == 1) {
                var x = event.pageX,
                    y = event.pageY;
                var mousePosition = new ClientCoordinate(x, y);
                var clientCornerCoordinate = playerProperties.getScreenCorner();
                mouseDownCoordinate.x = mousePosition.x;
                mouseDownCoordinate.y = mousePosition.y;

                mouseDownCoordinateWithCornerOffset.x = mouseDownCoordinate.x + clientCornerCoordinate.getX();
                mouseDownCoordinateWithCornerOffset.y = mouseDownCoordinate.y + clientCornerCoordinate.getY();

                drag = true;
            }

        }, false);

        canvas.addEventListener('mousewheel', function(event) {
            if (event.wheelDeltaY < 0) {
                if (scale > 1) {
                    scale -= 0.5;
                }
            } else {
                scale += 0.5;
            }
            scale.toPrecision(2);
            drawer.drawScene();
        }, false);
        canvas.addEventListener('mouseup', function(event) {
            drag = false;

            if (event.button == 0) {
                var x = event.pageX,
                    y = event.pageY;

                var mouseUpCoordinate = new ClientCoordinate(x, y);

                var movedOnX = Math.abs(mouseDownCoordinate.x - mouseUpCoordinate.x) == 0;
                var movedOnY = Math.abs(mouseDownCoordinate.y - mouseUpCoordinate.y) == 0;

                var ships = model.getShips();

                if (movedOnX && movedOnY) {
                    for (var i = 0; i < ships.length; i++) {
                        var ship = ships[i];
                        if (ship.isOnShape(mouseUpCoordinate)) {
                            ship.setSelected(!ship.isSelected());
                        } else {
                            ship.setSelected(false);
                        }

                    }
                    drawer.drawScene();
                }

            }

        }, false);
        canvas.addEventListener('mousemove', function(event) {
            var x = event.pageX,
                y = event.pageY;
            var mousePosition = new ClientCoordinate(x, y);

            if (drag) {
                playerProperties.setScreenCornerX(mouseDownCoordinateWithCornerOffset.x - mousePosition.x);
                playerProperties.setScreenCornerY(mouseDownCoordinateWithCornerOffset.y - mousePosition.y);

                drawer.drawScene();
            }
        }, false);
        var bindedSectionController = sectionController.sectionController.bind(sectionController);
        canvas.addEventListener('mousemove', bindedSectionController, false);
    </script>

</body>

</html>
